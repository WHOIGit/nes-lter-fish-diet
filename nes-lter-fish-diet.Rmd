---
title: "R Notebook"
output: html_notebook
---

```{r}
library(ediutilities)
library(glue)
library(here)
library(readr)
library(EMLassemblyline)
```

```{r}
count_table_name <- 'Concat_Count_EDI'
meas_table_name <- 'Concat_Meas_EDI'
```

Produce assembly line templates from Excel template


```{r}
excel_template <- 'LTER_ForageFish_Info.xlsx'

sheet_to_tsv(excel_template, 'ColumnHeaders',
             glue('attributes_{count_table_name}.txt'))

sheet_to_tsv(excel_template, 'ColumnHeaders',
             glue('attributes_{meas_table_name}.txt'))

sheet_to_tsv(excel_template, 'CategoricalVariables',
             glue('catvars_{count_table_name}.txt'))

sheet_to_tsv(excel_template, 'CategoricalVariables',
             glue('catvars_{meas_table_name}.txt'))

sheet_to_tsv(excel_template, 'Personnel', 'personnel.txt')
```
Use templates in "template core metadata" step from EML assembly line

```{r}
EMLassemblyline::template_core_metadata(path=here(), license='CCBY')
```
Compute spatiotemporal coverage. This requires reading the data

```{r}
count_table <- read_csv(here(glue('ForageFish_EDI/{count_table_name}.csv')))
meas_table <- read_csv(here(glue('ForageFish_EDI/{meas_table_name}.csv')))

# drop row index column from each table
count_table <- count_table[,-1]
meas_table <- meas_table[,-1]

# fix "MA" typo in meas_table
meas_table$preyCount <- as.numeric(dplyr::na_if(meas_table$preyCount, "MA"))

# cruise is not numeric
count_table$cruise <- as.factor(as.character(count_table$cruise))
meas_table$cruise <- as.factor(as.character(meas_table$cruise))
```

```{r}
# display data locations on a map
map_locs(count_table, xvar='decimalLongitude', yvar='decimalLatitude')
```

```{r}
write_csv(count_table, here(glue('{count_table_name}.csv')), quote="needed")
write_csv(meas_table, here(glue('{meas_table_name}.csv')), quote="needed")

temp_coverage <- temporal_coverage(append(count_table$BEGIN_GMT_TOWDATE,
                                          meas_table$BEGIN_GMT_TOWDATE))

geo_coords <- geographic_coordinates(
  append(count_table$decimalLatitude, meas_table$decimalLatitude),
  append(count_table$decimalLongitude, meas_table$decimalLongitude)
)
```

Produce EML

```{r}
pkg_id <- "knb-lter-nes.999.1" # dummy package ID for development

dataset_title = 'Diet composition for small pelagic fishes across the Northeast U.S. Continental Shelf for NES-LTER, ongoing since 2013'

make_eml(path=here(),
         #data.path=here('ForageFish_EDI'),
         dataset.title=dataset_title,
         data.table=c(glue('{count_table_name}.csv'),
                      glue('{meas_table_name}.csv')),
         data.table.description=c('This is a placeholder description (count)',
                                  'This is a placeholder description (meas)'),
         data.table.name = c('This is a placeholder table name (count)',
                             'This is a placeholder table name (meas)'),
         data.table.quote.character = c('"', '"'),
         temporal.coverage = temp_coverage,
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = geographic_coordinates(
            append(count_table$decimalLatitude, meas_table$decimalLatitude),
            append(count_table$decimalLongitude, meas_table$decimalLongitude)
         ),
         maintenance.description = "ongoing",
         user.id = "NES",
         user.domain = "LTER",
         package.id = pkg_id)

project_insert(pkg_id)

```